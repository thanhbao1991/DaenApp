@page
@model TraSuaAppWeb.Pages.DoanhThuNgayModel
@{
    ViewData["Title"] = "Doanh Thu Ngày";
    var ngay = Model.Ngay;
    var thang = Model.Thang;
    var nam = Model.Nam;

    var currentDate = new DateTime(nam, thang, ngay);
    var ngayTruoc = currentDate.AddDays(-1);
    var ngaySau = currentDate.AddDays(1);
}

<div class="modal fade" id="hoaDonModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body" id="hoaDonContent">
                <p>Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="chiTietModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body" id="chiTietContent">
                <p>Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-primary" href="?Ngay=@ngayTruoc.Day&Thang=@ngayTruoc.Month&Nam=@ngayTruoc.Year">← Ngày trước</a>
    <button type="button" class="btn btn-light" onclick="captureImage()">
        @ngay/@thang/@nam &#x1F4F7;
    </button>
    <a class="btn btn-outline-primary" href="?Ngay=@ngaySau.Day&Thang=@ngaySau.Month&Nam=@ngaySau.Year">Ngày sau →</a>
</div>

<div id="imagePreview" style="margin-top: 10px;"></div>

<div id="modalContent" class="container mt-3">
    <div style="position: relative; width: 300px; height: 300px; margin: auto;">
        <canvas id="doughnutChart" width="300" height="300"></canvas>

        <!-- Tổng doanh thu clickable -->
        <div style="
          position: absolute;
          top: 50%; left: 50%;
          transform: translate(-50%, -50%);
          text-align: center;
          font-size: 15px;
          font-weight: bold;
          color: #333;
      ">
            <a class="text-decoration-none text-primary"
               asp-page="/ThongKe"
               asp-route-ngay="@ngay"
               asp-route-thang="@thang"
               asp-route-nam="@nam">
                @String.Format("{0:N0}", Model.Data?.TongDoanhThu ?? 0)
            </a>
        </div>
    </div>

    <!-- Bảng này bây giờ nằm trong #modalContent luôn -->
    <table class="table table-sm table-bordered text-nowrap align-middle text-end mt-3">
        <tr>
            <td class="bg-light fw-bold text-start">Chi Tiêu</td>
            <td class="so-tien">
                <a asp-page="/ThongKe"
                   asp-route-ngay="@ngay"
                   asp-route-thang="@thang"
                   asp-route-nam="@nam"
                   asp-fragment="chitieu">
                    @string.Format("{0:N0}", Model.Data?.TongChiTieu ?? 0)
                </a>
            </td>
        </tr>
        <tr>
            <td class="bg-light fw-bold text-start">Banking</td>
            <td class="so-tien">
                @string.Format("{0:N0}", Model.Data?.TongChuyenKhoan ?? 0)
            </td>
        </tr>
        <tr>
            <td class="bg-light fw-bold text-start">Ghi Nợ</td>
            <td class="so-tien">
                <a asp-page="/ThongKe"
                   asp-route-ngay="@ngay"
                   asp-route-thang="@thang"
                   asp-route-nam="@nam"
                   asp-fragment="congno">
                    @string.Format("{0:N0}", Model.Data?.TongTienNo ?? 0)
                </a>
            </td>
        </tr>
        <tr>
            <td class="bg-light fw-bold text-start">Chưa làm</td>
            <td class="so-tien text-start">
                <ul class="mb-0">
                    @foreach (var task in (Model.Data?.ViecChuaLam ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries))
                    {
                        <li>@task.Trim()</li>
                    }
                </ul>
            </td>
        </tr>
    </table>
</div> <!-- ✅ Đóng modalContent ở cuối cùng -->

    @* === BẢNG ĐƠN HÀNG CHÍNH === *@
    <table class="table table-sm table-bordered">
        <thead class="table-light">
            <tr>
                <th>Giờ</th>
                <th>Bàn / Khách</th>
                <th class="text-end">Tiền</th>
            </tr>
            <tr>
                <td class="center-middle text-danger">
                    <a asp-page="/TaoHoaDon">@Model.Data?.TongSoDon</a>
                </td>
                <td></td>
                <td class="center-middle text-end text-danger" style="font-variant-numeric: tabular-nums;"
                    data-bs-toggle="tooltip" data-bs-html="true"
                    title="Thu: @String.Format("{0:N0}", (Model.Data?.TongDaThu ?? 0) / 1000)<br>Còn: @String.Format("{0:N0}", (Model.Data?.TongConLai ?? 0) / 1000)">
                    @String.Format("{0:N0}", (Model.Data?.TongDoanhThu ?? 0) / 1000)
                </td>
            </tr>
        </thead>
        <tbody>
            @if (Model.Data?.HoaDons != null)
            {
                foreach (var item in Model.Data.HoaDons
                .OrderByDescending(x => x.PhanLoai == "Ship" && x.NgayShip == null)
                .ThenByDescending(x => x.NgayHoaDon))
                {
                    string hienThiThoiGian;
                    if (item.PhanLoai == "Ship" && item.NgayShip == null)
                        hienThiThoiGian = $"{(int)(DateTime.Now - item.NgayHoaDon).TotalMinutes}'";
                    else
                        hienThiThoiGian = item.NgayHoaDon.ToString("HH:mm");

                    string iconTrangThai = "";
                    if (item.BaoDon) iconTrangThai = "\uD83D\uDD14";
                    else if (item.PhanLoai == "Tại Chỗ") iconTrangThai = "\uD83E\uDE91";
                    else if (item.PhanLoai == "Mv") iconTrangThai = "\uD83D\uDECD";
                    else if (item.PhanLoai == "App") iconTrangThai = "\uD83D\uDCF1";
                    else if (item.PhanLoai == "Ship")
                        iconTrangThai = item.NgayShip == null ? "\uD83D\uDC69\u200D\uD83C\uDF73" : "\uD83D\uDEF5";

                    string hienThiText = item.TenKhachHangText == "" ? item.ThongTinHoaDon : item.TenKhachHangText;
                    var tien = GetThongTinTien(item);

                    <tr>
                        <td class="center-middle">@hienThiThoiGian</td>
                        <td>
                            <span style="font-size: 1.2rem; margin-right: 4px;">@iconTrangThai</span>
                            <a class="text-decoration-none" href="javascript:void(0)"
                               onclick="xemHoaDonKhachHang('@item.IdKhachHang',@Model.Ngay,@Model.Thang,@Model.Nam)">
                                @hienThiText
                            </a>
                        </td>
                        <td class="so-tien text-end" style="background-color:@tien.MauNen"
                            data-bs-toggle="tooltip" data-bs-html="true" title="@tien.Tooltip">
                            <a class="text-decoration-none" href="javascript:void(0)" onclick="xemChiTiet('@item.Id')">
                                @tien.SoTien
                            </a>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script>
        const ctx = document.getElementById('doughnutChart').getContext('2d');
        const data = {
            labels: ['Tại chỗ', 'Mua về', 'Ship', 'App'],
            datasets: [{
                data: [@Model.Data?.TaiCho ?? 0, @Model.Data?.MuaVe ?? 0, @Model.Data?.DiShip ?? 0, @Model.Data?.AppShipping ?? 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)'
                ],
                borderColor: ['white', 'white', 'white', 'white'],
                borderWidth: 1
            }]
        };
        const config = {
            type: 'doughnut',
            data: data,
            options: {
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    datalabels: {
                        color: '#000',
                        font: { weight: 'bold' },
                        align: 'center',
                        anchor: 'center',
                        textAlign: 'center',
                        lineHeight: 1.2,
                        formatter: function (value, context) {
                            const icons = ['\uD83E\uDE91', '\uD83D\uDECD', '\uD83D\uDEF5', '\uD83D\uDCF1'];
                            return value.toLocaleString('vi-VN') + '\n' + icons[context.dataIndex];
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        };
        new Chart(ctx, config);
    </script>
}
@functions {
    public class TienHienThi
    {
        public string MauNen { get; set; } = string.Empty;
        public string SoTien { get; set; } = string.Empty;
        public string Tooltip { get; set; } = string.Empty;
    }

    // Hiển thị hoàn toàn theo ConLai (đã đồng bộ backend)
    public TienHienThi GetThongTinTien(TraSuaApp.Shared.Dtos.DoanhThuHoaDonDto item)
    {
        var r = new TienHienThi();
        var tong = Math.Max(0, item.TongTien);
        var conLai = Math.Max(0, item.ConLai);

        if (conLai >= tong) // chưa thu đồng nào
        {
            r.MauNen = "white";
            r.SoTien = tong.ToString("N0");
            r.Tooltip = "Chưa thu";
        }
        else if (conLai > 0) // đã thu một phần (còn nợ)
        {
            r.MauNen = "#ffcccc";
            r.SoTien = conLai.ToString("N0");
            r.Tooltip = "Khách còn nợ";
        }
        else // conLai == 0: đã thu đủ
        {
            r.MauNen = "#ccffcc";
            r.SoTien = "0";
            r.Tooltip = "Đã thu đủ";
        }

        return r;
    }
}