@page
@model TraSuaAppWeb.Pages.ChiTietHoaDonNoTabModel
@{
    ViewData["Title"] = "Công Nợ Khách Hàng";
}

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <i class="fa fa-money-bill-wave text-success"></i>
            Công Nợ Khách Hàng
        </h4>
        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
            <i class="fa fa-sync"></i> Tải lại
        </button>
    </div>

    <div class="input-group mb-3">
        <span class="input-group-text"><i class="fa fa-search"></i></span>
        <input type="text"
               class="form-control"
               id="searchBox"
               placeholder="Tìm khách hàng, ghi chú..."
               onkeyup="filterTable(this.value)">
    </div>

    <div class="table-responsive">
        <table id="noTable" class="table table-striped table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>Tên</th>
                    <th>Ngày</th>
                    <th class="text-end">Số nợ</th>
                    <th class="text-end">Còn lại</th>
                    <th>Ghi chú</th>
                    <th class="text-center">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td>@item.Ten</td>
                        <td>@item.Ngay.ToString("dd/MM")</td>
                        <td class="text-end">@item.SoTienNo.ToString("N0")</td>
                        <td class="text-end fw-bold text-danger">@item.SoTienConLai.ToString("N0")</td>
                        <td>@item.GhiChu</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-success me-1"
                                    title="Thanh toán tiền mặt"
                                    onclick="payDebt('@item.Id','TienMat')">
                                <i class="fa fa-money-bill-wave"></i>
                            </button>
                            <button class="btn btn-sm btn-warning fw-bold"
                                    title="Thanh toán chuyển khoản"
                                    onclick="payDebt('@item.Id','ChuyenKhoan')">
                                <i class="fa fa-university"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3 text-end">
        <strong>Tổng còn lại:</strong>
        <span class="text-danger fw-bold">@Model.TotalConLai.ToString("N0") đ</span>
    </div>
</div>

@section Scripts {
    <script>
        // 🟟 Chuẩn hoá text giống StringHelper.MyNormalizeText()
        function normalizeText(str) {
            return str
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/đ/g, 'd')
                .replace(/[^a-z0-9]/g, '');
        }

        // 🟟 Tìm kiếm không dấu
        function filterTable(keyword) {
            const keyNorm = normalizeText(keyword);
            document.querySelectorAll("#noTable tbody tr").forEach(row => {
                const text = normalizeText(row.innerText);
                row.style.display = text.includes(keyNorm) ? "" : "none";
            });
        }

        // 🟟 Gọi API trả nợ (xử lý ở backend)
        async function payDebt(id, type) {
            const text = type === "TienMat" ? "tiền mặt" : "chuyển khoản";
            if (!confirm("Xác nhận thanh toán nợ này bằng " + text + "?")) return;

            const btns = document.querySelectorAll('button[onclick*="' + id + '"]');
            btns.forEach(b => b.disabled = true);

            try {
                const res = await fetch('/ChiTietHoaDonNoTab?handler=Pay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, type })
                });
                const result = await res.json();
                alert(result.message);
                if (result.success) location.reload();
                else btns.forEach(b => b.disabled = false);
            } catch (e) {
                alert("Lỗi: " + e);
                btns.forEach(b => b.disabled = false);
            }
        }
    </script>
}