@inject IConfiguration Configuration
@{
    // đọc tên hiển thị nếu có (được set sau khi login)
    var displayName = Context.Request.Cookies["display_name"];
    // tuyệt đối KHÔNG render access_token / api keys ra UI
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>@ViewData["Title"] - Denn</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
        // chỉ để client biết API base, không chứa secret
        window.apiBaseUrl = "@Configuration["ApiSettings:BaseUrl"]";

                function xemHoaDonKhachHang(khachHangId) {
            if (!khachHangId) return;
            const container = document.getElementById('hoaDonContent');
            container.innerHTML = "<p>Đang tải danh sách...</p>";

            // mở modal
            new bootstrap.Modal(document.getElementById('hoaDonModal')).show();

            const url = `${window.apiBaseUrl}/api/doanhthu/danhsach?khachHangId=${khachHangId}`;
            fetch(url)
                .then(res => res.json())
                .then(res => {
                    if (!res.isSuccess) {
                        container.innerHTML = "<p class='text-danger'>Không tải được danh sách hóa đơn</p>";
                        return;
                    }

                    const rows = (res.data || [])
                        // đảm bảo sắp xếp mới nhất trước
                        .sort((a, b) => new Date(b.ngayHoaDon) - new Date(a.ngayHoaDon));

                    let html = `
                        <table class="table table-sm table-bordered">
                          <thead class="table-light">
                            <tr>
                              <th>Ngày giờ</th>
                              <th>Khách hàng</th>
                              <th class="text-end">Còn lại</th>
                            </tr>
                          </thead>
                          <tbody>`;

                    rows.forEach(item => {
                        // ⚠️ dùng đúng camelCase từ API: ngayHoaDon, thongTinHoaDon, tongTien, daThu, conLai, id
                        const ngayGio = new Date(item.ngayHoaDon).toLocaleString('vi-VN', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });

                        const tong = Number(item.tongTien || 0);
                        const daThu = Number(item.daThu || 0);
                        const conLai = Number(item.conLai || (tong - daThu));

                        html += `
                            <tr>
                                <td>${ngayGio}</td>
                            <td>
          ${[item.tenKhachHangText, item.thongTinHoaDon].filter(Boolean).join(" - ")}
        </td>
                                <td class="text-end">
                                    <a href="javascript:void(0)" onclick="xemChiTiet('${item.id}')">
                                        ${conLai.toLocaleString('vi-VN')} đ
                                    </a>
                                </td>
                            </tr>`;
                    });

                    html += "</tbody></table>";
                    container.innerHTML = html;
                })
                .catch(err => {
                    container.innerHTML = "<p class='text-danger'>Lỗi tải dữ liệu</p>";
                    console.error(err);
                });
        }






              // ================================
                // 🟟 Hàm xem chi tiết hoá đơn
                // ================================
                function xemChiTiet(id) {
                    if (!id) return;
                    $('#chiTietContent').html("<p>Đang tải dữ liệu...</p>");
                    $('#chiTietModal').modal('show');

                    const url = `${window.apiBaseUrl}/api/doanhthu/chitiet?hoaDonId=${id}`;
                    fetch(url)
                        .then(res => res.json())
                        .then(res => {
                            if (!res.isSuccess) {
                                $('#chiTietContent').html("<p class='text-danger'>Không tải được chi tiết hóa đơn</p>");
                                return;
                            }

                            const list = res.data;
                            let html = "";

                            const icons = ["0️⃣","1️⃣","2️⃣","3️⃣","4️⃣","5️⃣","6️⃣","7️⃣","8️⃣","9️⃣"];
                            function getIcon(num) {
                                if (num === 10) return "🟟";
                                if (num < 10) return icons[num];
                                return num.toString().split("").map(c => icons[parseInt(c)]).join("");
                            }

                            list.forEach(item => {
                                const iconSo = getIcon(item.soLuong);
                                html += `
                                  <div class="mx-3 d-flex justify-content-between align-items-center item-row py-2 ${item.thanhTien == 0 ? "opacity-25" : ""}">
                                      <div>
                                          <span class="item-text">${iconSo} ${item.tenSanPham}</span>
                                          ${item.ghiChu ? `<div class="item-note">${item.ghiChu}</div>` : ""}
                                      </div>
                                      <span class="fw-bold text-danger">${item.thanhTien.toLocaleString()}</span>
                                  </div>
                                `;
                            });

                            const tong = list.reduce((s, x) => s + x.thanhTien, 0);
                            html += `
                              <div class="border-top mt-4 pt-2 d-flex justify-content-between fw-bold text-danger">
                                  <span>Tổng</span>
                                  <span>${tong.toLocaleString()} đ</span>
                              </div>
                            `;

                            $('#chiTietContent').html(html);
                        })
                        .catch(err => {
                            $('#chiTietContent').html("<p class='text-danger'>Lỗi tải dữ liệu</p>");
                            console.error(err);
                        });
                }

    </script>
</head>

<body>
    <header>
        @if (ViewData["HideMenu"] as bool? != true)
        {
            <nav class="navbar navbar-expand-sm navbar-light bg-white border-bottom mb-3">
                <div class="container-fluid">
                    <button class="navbar-toggler" type="button" id="menuToggleButton" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <a class="navbar-brand fw-bold" asp-page="/Index">Đenn</a>

                    <div class="collapse navbar-collapse" id="mainNavbar">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link" asp-page="/DoanhThuNgay">
                                    <span class="ico me-2">&#x2B55;</span> <!-- ⭕ -->
                                    Doanh Thu Ngày
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" asp-page="/DoanhThuThang">
                                    <span class="ico me-2">&#x1F4CA;</span> <!-- 🟟 -->
                                    Doanh Thu Tháng
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" asp-page="/ThongKe">
                                    <span class="ico me-2">&#x1F4C8;</span> <!-- 🟟 -->
                                    Thống kê
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" asp-page="/ChiTieuNha">
                                    <span class="ico me-2">&#x1F4B8;</span> <!-- 🟟: Ứng Nhã -->
                                    Ứng Nhã
                                </a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link" asp-page="/Voucher">
                                    <span class="ico me-2">&#x1F39F;</span> <!-- 🟟: Voucher -->
                                    Voucher &amp; Chiết khấu
                                </a>
                            </li>


                        </ul>

                        <div class="d-flex align-items-center">
                            @if (!string.IsNullOrWhiteSpace(displayName))
                            {
                                <span class="me-3 text-muted">Xin chào, <b>@displayName</b></span>
                                <form asp-page="/Login" asp-page-handler="Logout" method="post" class="d-inline">
                                    <button class="btn btn-outline-secondary btn-sm" type="submit">Đăng xuất</button>
                                </form>
                            }
                            else
                            {
                                <a class="btn btn-outline-primary btn-sm" asp-page="/Login">Đăng nhập</a>
                            }
                        </div>
                    </div>
                </div>
            </nav>
        }
    </header>

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    @if (ViewData["HideMenu"] as bool? != true)
    {
        <footer class="border-top footer text-muted"></footer>
    }

    @await RenderSectionAsync("Scripts", required: false)

    <script>
        // Đóng/mở menu trên mobile
        window.addEventListener('load', function () {
            const menuButton = document.getElementById('menuToggleButton');
            const navbar = document.getElementById('mainNavbar');
            let isMenuOpen = false;
            menuButton.addEventListener('click', function () {
                navbar.classList.toggle('show');
                isMenuOpen = !isMenuOpen;
            });
            document.querySelectorAll('#mainNavbar .nav-link').forEach(link => {
                link.addEventListener('click', function () {
                    setTimeout(() => { navbar.classList.remove('show'); isMenuOpen = false; }, 200);
                });
            });
        });
    </script>
</body>
</html>