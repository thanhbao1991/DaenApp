@page
@model TraSuaAppWeb.Pages.DoanhThuThangModel
@{
    ViewData["Title"] = "Doanh Thu Tháng";
    var thang = Model.Thang;
    var nam = Model.Nam;

    var thangTruoc = thang == 1 ? 12 : thang - 1;
    var namTruoc = thang == 1 ? nam - 1 : nam;

    var thangSau = thang == 12 ? 1 : thang + 1;
    var namSau = thang == 12 ? nam + 1 : nam;
}

<div class="modal fade" id="hoaDonModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body" id="hoaDonContent">
                <p>Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="chiTietModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body" id="chiTietContent">
                <p>Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-primary" href="?Thang=@thangTruoc&Nam=@namTruoc">← Tháng trước</a>
    <button type="button" class="btn btn-light" onclick="captureImage()">
        @thang/@nam &#x1F4C5;
    </button>
    <a class="btn btn-outline-primary" href="?Thang=@thangSau&Nam=@namSau">Tháng sau →</a>
</div>

<div id="imagePreview" style="margin-top: 10px;"></div>

<canvas id="chartDoanhThu" height="100"></canvas>

<div class="container mt-3">
    <table class="table table-sm table-bordered text-nowrap align-middle text-end">
        <tr>
            <td class="bg-light fw-bold text-start">Lợi Nhuận</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.TongDoanhThu - Model.TongChiTieu)
            </td>
            <td class="bg-light fw-bold text-start">Tại Chỗ</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.DoanhThuTheoNgay.Sum(x => x.TaiCho))
            </td>
        </tr>
        <tr>
            <td class="bg-light fw-bold text-start">Banking</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.TongChuyenKhoan)
            </td>
            <td class="bg-light fw-bold text-start">Mua Về</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.DoanhThuTheoNgay.Sum(x => x.MuaVe))
            </td>
        </tr>
        <tr>
            <td class="bg-light fw-bold text-start">Tiền Mặt</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.TongTienMat)
            </td>
            <td class="bg-light fw-bold text-start">Ship</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.DoanhThuTheoNgay.Sum(x => x.DiShip))
            </td>
        </tr>
        <tr>
            <td class="bg-light fw-bold text-start">Ghi Nợ</td>
            <td class="text-end" style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.TongTienNo)
            </td>
            <td class="bg-light fw-bold text-start">App</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.DoanhThuTheoNgay.Sum(x => x.AppShipping))
            </td>
        </tr>
        <tr>
            <td class="bg-light fw-bold text-start">Thưởng</td>
            <td class="text-end" style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", Model.ThuongNha)
            </td>
            <td class="bg-light fw-bold text-start">Ứng</td>
            <td style="font-variant-numeric: tabular-nums;">
                @string.Format("{0:N0}", -1)
            </td>
        </tr>
    </table>

    <table class="table table-sm table-bordered">
        <thead class="table-light">
            <tr>
                <th>Ngày</th>
                <th>Số đơn</th>
                <th class="text-end">Doanh thu</th>
                <th class="text-end">Chi tiêu</th>
            </tr>
            <tr>
                <td class="fw-bold text-start">Tổng</td>
                <td class="text-end" style="font-variant-numeric: tabular-nums;">
                    @string.Format("{0:N0}", Model.TongSoDon)
                </td>
                <td class="text-end" style="font-variant-numeric: tabular-nums;">
                    @string.Format("{0:N0}", Model.TongDoanhThu)
                </td>
                <td class="text-end" style="font-variant-numeric: tabular-nums;">
                    @string.Format("{0:N0}", Model.TongChiTieu)
                </td>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.DoanhThuTheoNgay.OrderByDescending(x => x.Ngay))
            {
                <tr>
                    <td class="ngay-thang">
                        <a asp-page="/DoanhThuNgay" asp-route-ngay="@item.Ngay.Day"
                           asp-route-thang="@item.Ngay.Month"
                           asp-route-nam="@item.Ngay.Year">
                            @item.Ngay.ToString("dd/MM")
                        </a>
                    </td>
                    <td class="so-tien">@item.SoDon</td>
                    <td class="so-tien">@item.TongTien.ToString("N0")</td>
                    <td class="so-tien">@item.ChiTieu.ToString("N0")</td>
                </tr>
            }
        </tbody>
    </table>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script>
        const labels = [@Html.Raw(string.Join(",", Model.DoanhThuTheoNgay.Select(d => $"'{d.Ngay:dd/MM}'")))];
        const doanhThuData = [@string.Join(",", Model.DoanhThuTheoNgay.Select(d => d.TongTien))];

        const ctx = document.getElementById('chartDoanhThu').getContext('2d');
        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Doanh Thu',
                        data: doanhThuData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        };
        new Chart(ctx, config);
    </script>
}